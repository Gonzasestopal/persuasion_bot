# 🤖 Persuasion Bot
An LLM-based chatbot that takes in messages from a user, processes them, and generates responses intended to defend itself or maintain its position during an ongoing conversation.

## 📜 Table of Contents
1. [Overview](#overview)
2. [Architecture](#architecture)
3. [Entities](#entities)
4. [Folder Structure](#folder-structure)
5. [Tech Stack](#tech-stack)
6. [Getting Started](#getting-started)
7. [API Documentation](#api-documentation)
8. [Example Requests](#example-requests)
9. [Non Functional Requirements](#non-functional-requirements)
10. [Database Optimization](#database-optimization)
11. [Production Considerations](#production-considerations)
12. [LLM](#llm)
13. [Deployment Guide](#deployment-guide)
14. [Testing](#testing)

---

## Overview
This application challenges you to persuade a chatbot to adopt your point of view while it stands its ground on the initial stance.

Includes:
- Single endpoint to handle messages and responses.
- Conversation history capped at the 5 most recent user+bot pairs.

---

## Architecture
![Architecture Diagram](docs/architecture.png?v=2)

- **Client**: Anyone consuming the API.
- **API**: REST API built with FastAPI.
- **Database**: PostgreSQL.
- **Cache**: Redis Cache to improve latency and enable rate limiting.

---

## Entities
![Entities](docs/entities.png)

**Messages**
- `id`: autogenerated
- `conversation_id`: related conversation
- `message`: content
- `role`: (user, bot)
- `timestamps`

**Conversations**
- `id`: autogenerated
- `side`: bot stance (con, pro)
- `topic`: discussion subject
- `timestamps`

---

## Folder Structure
```text
persuasion_bot/
├── app/                # Main application code (API, domain logic, adapters, services)
├── docs/               # Project documentation (guides, architecture diagrams, notes)
├── migrations/         # Database migration scripts (likely using Yoyo)
├── tests/              # Unit and integration tests for the project
├── .dockerignore       # Files/folders excluded when building Docker images
├── .env.example        # Example environment variables template
├── .gitignore          # Specifies files ignored by Git
├── Dockerfile          # Instructions to build the Docker container
├── Makefile            # Automation commands (run, test, migrate, etc.)
├── README.md           # Project overview, installation, usage instructions
├── docker-compose.yml  # Multi-container setup (API, DB, etc.) for local/dev
├── requirements.txt    # Python dependencies list
└── yoyo.ini            # Configuration for Yoyo database migrations
```

---

## Tech Stack
- **Backend**: FastAPI (Python 3.9+)
- **Database**: PostgreSQL
- **API Docs**: Swagger UI / ReDoc (auto-generated)
- **Containerization**: Docker

---

## Getting Started

### Prerequisites
- Docker (required) → [Install Guide](https://docs.docker.com/engine/install/)
- GNU Make (required) → [Install Guide](https://www.gnu.org/software/make/)

- Python & pip (optional, for local dev/tests) →[Install Guide](https://wiki.python.org/moin/BeginnersGuide/Download)
- Virtualenv(optional, for local dev/tests) → [Install Guide](https://virtualenv.pypa.io/en/latest/installation.html)
- PostgreSQL (optional, for local dev)  → [Install Guide](https://www.postgresql.org/docs/current/tutorial-install.html)

### Clone Repository
```bash
git clone https://github.com/gonzasestopal/persuasion_bot.git
cd persuasion_bot
```

### Environment
Copy `.env.example` to `.env`:
```
DATABASE_URL=postgresql://app:app@db:5432/app
OPENAI_API_KEY=key
LLM_PROVIDER=openai
LLM_MODEL=gpt-4o
DIFFICULTY=easy|medium
```

### Running the service
```bash
make run
```

### Running tests
```bash
make test
```

### Cleanup
```bash
make down   # stop Docker services
make clean  # remove venv, caches
```

---

## API Documentation

Base URL:
- **Local:** `http://localhost:8000`

No authentication required.

### Messages
| Method | Endpoint    | Description                       |
|--------|------------|-----------------------------------|
| `POST` | `/messages`| Inserts a new message / Starts convo |

---

## Example Requests

> [!IMPORTANT]
> First message must include `topic` and `side` (PRO, CON).

**Start a new conversation** 201
```http
POST /messages
```
```json
{
  "conversation_id": null,
  "message": "Topic: Sports build discipline and community. Side: PRO."
}
```

**Continue a conversation** 200
```json
{
  "conversation_id": 1,
  "message": "But sports also divide people"
}
```

**Mapped Errors**
```
{ "detail": "message must not be empty." }                                       # 422 Unprocessable Entity
{ "detail": "message must contain topic and side for starting a conversation." } # 422 Unprocessable Entity
{ "detail": "conversation_id must be null when starting a conversation" }        # 422 Unprocessable Entity
{ "detail": "conversation_id not found or expired" }                             # 404 Not Found
{ "detail": "response generation timed out" }                                    # 503 Bad Gateway
````

---

## Non Functional Requirements
- **Latency**: < 30s response, 25s internal timeout.
- **Scalability**: Redis caching for LLM + history.
- **History Window**: last 5 user+bot pairs only.
- **Fault Tolerance**: fallback short replies on timeout.
- **Storage**: conversations expire after 60m inactivity.

---

<details>
  <summary>⚡ Database Optimization (click to expand)</summary>

- **conversations (expires_at)**
  Speeds up lookups for active conversations.

- **messages (conversation_id, created_at)**
  Optimizes retrieval of the last N messages.

- **messages (conversation_id, created_at DESC, id DESC)**
  Optimizes “latest N” queries with deterministic ordering.

</details>

---

<details>
  <summary>🛡️ Production Considerations (click to expand)</summary>

- Expired conversations not physically deleted (cleanup job needed in prod).
- Use **atomic transactions** to store user+bot messages together.

**Caching Strategy**
1. **Idempotency keys** → prevent retries from duplicating.
2. **Conversation history cache** → Redis, TTL 30–60m.
3. **LLM reply cache** → hash-based key, TTL 1–24h.

</details>

---

<details>
  <summary>🧠 LLM Details (click to expand)</summary>

We support **OpenAI GPT-4o** and **Anthropic Claude 3.5**.

- **Prompt budget:** ≤ 3k tokens.
- **Output cap:** ~80–120 tokens.
- **Window:** last 5 user+bot pairs included.

**GPT-4o**
- Fastest, first tokens in 1–2s, usually <10s for full reply.

**Claude 3.5 Sonnet**
- More conversational, <10s medium replies, slightly slower than GPT-4o.

**Claude 3.5 Opus**
- Excluded (too slow, can exceed 30s SLA).

</details>

---

<details>
  <summary>🚀 Deployment Guide (click to expand)</summary>

1. Provision **PostgreSQL** (Supabase/Neon/etc.).

2. Build & push Docker image:
   ```bash
   docker build -t gonzasestopal/persuasion-bot:v1 .
   docker push gonzasestopal/persuasion-bot:v1
   ```

3. Configure env vars in PaaS:
   ```
   DATABASE_URL=postgres://...
   OPENAI_API_KEY=your_api_key
   ```

4. Deploy container image.

5. Run migrations:
   ```bash
   make migrate
   ```

</details>

---


<details>
  <summary> 🧪 Testing  (click to expand) </summary>

### Install Dependencies
Ensure all required dependencies are installed before running the test suite:
```bash
make install
```
### Run Tests with Coverage
Execute the full test suite with coverage reporting:
```bash
make test
```

</details>
